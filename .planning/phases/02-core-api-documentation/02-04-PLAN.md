---
phase: 02-core-api-documentation
plan: 04
type: execute
wave: 2
depends_on: ["02-03"]
files_modified:
  - skills/polymarket/trading/order-placement.md
  - skills/polymarket/trading/order-management.md
  - skills/polymarket/trading/positions-and-balances.md
autonomous: true

must_haves:
  truths:
    - "Documentation shows complete order placement workflow with request/response"
    - "Documentation covers order cancellation patterns"
    - "Documentation explains order status checking and open orders retrieval"
    - "Documentation covers position viewing and balance checking"
    - "Documentation includes batch order operations"
  artifacts:
    - path: "skills/polymarket/trading/order-placement.md"
      provides: "Complete order placement workflow"
      min_lines: 100
    - path: "skills/polymarket/trading/order-management.md"
      provides: "Cancellation, status, batch operations"
      min_lines: 100
    - path: "skills/polymarket/trading/positions-and-balances.md"
      provides: "Position and balance queries"
      min_lines: 80
  key_links:
    - from: "skills/polymarket/trading/order-placement.md"
      to: "order-types.md"
      via: "order type selection"
      pattern: "order-types"
    - from: "skills/polymarket/trading/order-management.md"
      to: "order-placement.md"
      via: "order lifecycle"
      pattern: "order-placement"
---

<objective>
Complete trading documentation with order placement workflow, management operations, and position tracking.

Purpose: Enable Claude to handle the complete order lifecycle - from placement through management to position tracking. Covers CLOB-01 (detailed placement), CLOB-02 (cancellation), CLOB-03 (status), CLOB-04 (positions), CLOB-06 (batch).

Output: Three skill files completing the trading skill folder.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-api-documentation/02-RESEARCH.md

# Reference prior plans in this phase
@skills/polymarket/auth/client-initialization.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create order placement documentation</name>
  <files>skills/polymarket/trading/order-placement.md</files>
  <action>
Create comprehensive order placement documentation (CLOB-01 detailed) covering:

1. **Pre-Placement Checklist:**
   - Authenticated client (set_api_creds called)
   - Token ID from Gamma API
   - Current tick size checked
   - Sufficient balance (USDC.e for BUY, shares for SELL)

2. **Getting Market Context:**
   ```python
   # Always check before placing orders
   tick_size = client.get_tick_size(token_id)
   midpoint = client.get_midpoint(token_id)
   book = client.get_order_book(token_id)

   print(f"Tick size: {tick_size}")
   print(f"Midpoint: {midpoint}")
   print(f"Best bid: {book['bids'][0] if book['bids'] else 'None'}")
   print(f"Best ask: {book['asks'][0] if book['asks'] else 'None'}")
   ```

3. **Complete Order Placement Flow:**
   ```python
   from py_clob_client.clob_types import OrderArgs, OrderType
   from py_clob_client.order_builder.constants import BUY, SELL

   # Step 1: Build order arguments
   order_args = OrderArgs(
       price=0.45,       # Must align with tick size
       size=100.0,       # Number of shares
       side=BUY,         # BUY or SELL
       token_id=token_id
   )

   # Step 2: Sign the order
   signed_order = client.create_order(order_args)

   # Step 3: Post to CLOB
   response = client.post_order(signed_order, OrderType.GTC)

   # Step 4: Handle response
   if response.get("success"):
       order_id = response["orderId"]
       status = response["status"]  # live, matched, delayed
       print(f"Order {order_id}: {status}")
   else:
       print(f"Failed: {response.get('errorMsg')}")
   ```

4. **Request Schema:**
   Document OrderArgs fields:
   - price: Limit price (0.01-0.99), must align with tick size
   - size: Number of shares
   - side: BUY or SELL constant
   - token_id: From Gamma API clobTokenIds
   - expiration: (optional) Unix timestamp for GTD orders

5. **Response Schema:**
   ```python
   # Success response
   {
       "success": True,
       "orderId": "0x123...",
       "status": "live",        # live, matched, delayed
       "size_matched": 0.0,     # Immediately filled amount
       "price_average": 0.0     # Average fill price
   }

   # Error response
   {
       "success": False,
       "errorMsg": "Invalid tick size"
   }
   ```

6. **Order Status Values:**
   - live: Resting on orderbook
   - matched: Partially or fully matched
   - delayed: Processing (check again)

7. **Tick Size Validation:**
   ```python
   # Validate price against tick size
   def validate_price(price: float, tick_size: float) -> float:
       """Round price to valid tick size."""
       return round(price / tick_size) * tick_size

   tick_size = float(client.get_tick_size(token_id))
   validated_price = validate_price(0.456, tick_size)
   ```

8. **Common Errors:**
   - INVALID_ORDER_MIN_TICK_SIZE: Price not aligned with tick size
   - invalid amounts: FOK precision too high (use GTC)
   - insufficient balance: Check USDC.e / position balance
  </action>
  <verify>File exists at skills/polymarket/trading/order-placement.md with 100+ lines, includes complete placement workflow, request/response schemas, and error handling</verify>
  <done>Complete order placement documentation with full workflow, schemas, and validation patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create order management documentation</name>
  <files>skills/polymarket/trading/order-management.md</files>
  <action>
Create comprehensive order management documentation (CLOB-02, CLOB-03, CLOB-06) covering:

1. **Order Cancellation (CLOB-02):**
   ```python
   # Cancel single order
   cancel_response = client.cancel(order_id)

   if cancel_response.get("canceled"):
       print(f"Order {order_id} cancelled")
   else:
       print(f"Cancel failed: {cancel_response}")
   ```

2. **Cancel All Orders:**
   ```python
   # Cancel all open orders
   response = client.cancel_all()
   print(f"Cancelled {response.get('canceled', 0)} orders")
   ```

3. **Order Status Checking (CLOB-03):**
   ```python
   # Get single order
   order = client.get_order(order_id)

   print(f"Status: {order['status']}")
   print(f"Original size: {order['original_size']}")
   print(f"Size matched: {order.get('size_matched', 0)}")
   print(f"Price: {order['price']}")
   ```

4. **Get Open Orders:**
   ```python
   # All open orders
   open_orders = client.get_orders()

   for order in open_orders:
       print(f"{order['id']}: {order['side']} {order['original_size']} @ {order['price']}")

   # Filter by market
   market_orders = client.get_orders(market=condition_id)
   ```

5. **Order Response Schema:**
   ```python
   {
       "id": "0x123...",
       "status": "LIVE",        # LIVE, MATCHED, CANCELED
       "maker_address": "0x...",
       "market": "0x...",       # conditionId
       "asset_id": "71321...",  # token_id
       "side": "BUY",
       "original_size": "100.0",
       "size_matched": "25.0",  # Filled amount
       "price": "0.45",
       "created_at": "2024-01-15T10:30:00Z",
       "expiration": 0          # Unix timestamp or 0 for GTC
   }
   ```

6. **Batch Order Operations (CLOB-06):**
   ```python
   from py_clob_client.clob_types import PostOrdersArgs

   # Batch order placement (max 15 orders)
   orders = []
   for price in [0.40, 0.41, 0.42]:
       order_args = OrderArgs(
           price=price,
           size=20.0,
           side=BUY,
           token_id=token_id
       )
       signed = client.create_order(order_args)
       orders.append(PostOrdersArgs(
           order=signed,
           orderType=OrderType.GTC
       ))

   responses = client.post_orders(orders)

   for i, resp in enumerate(responses):
       if resp["success"]:
           print(f"Order {i+1}: {resp['orderId']}")
       else:
           print(f"Order {i+1} failed: {resp['errorMsg']}")
   ```

7. **Batch Cancellation:**
   ```python
   # Cancel multiple orders by ID
   order_ids = ["0x123...", "0x456...", "0x789..."]
   cancel_responses = client.cancel_orders(order_ids)
   ```

8. **Batch Limits:**
   - Maximum 15 orders per batch POST
   - Batch cancel has no strict limit but use reasonable batches
   - Failed orders don't affect other orders in batch

9. **Order Lifecycle Diagram:**
   ```
   create_order() -> post_order() -> LIVE
                                      |
                        ┌─────────────┼─────────────┐
                        ↓             ↓             ↓
                    MATCHED      cancel()      expiration
                        ↓             ↓             ↓
                    (fills)       CANCELED     CANCELED
   ```
  </action>
  <verify>File exists at skills/polymarket/trading/order-management.md with 100+ lines, includes cancellation, status checking, open orders, and batch operations</verify>
  <done>Complete order management documentation with cancellation patterns, status queries, and batch operations</done>
</task>

<task type="auto">
  <name>Task 3: Create positions and balances documentation</name>
  <files>skills/polymarket/trading/positions-and-balances.md</files>
  <action>
Create positions and balances documentation (CLOB-04) covering:

1. **CLOB Position Methods:**
   ```python
   # Get position in a specific market
   position = client.get_positions(
       market=condition_id,
       side="BUY"  # or "SELL"
   )
   ```

2. **Understanding Positions:**
   - Position = shares you hold
   - YES position from BUY orders filled
   - NO position from SELL orders filled (or direct NO purchase)
   - Positions resolve to $1 or $0 at market close

3. **Balance Checking via CLOB:**
   ```python
   # Get available balance for trading
   # Note: Balance info typically comes from on-chain queries
   # CLOB provides position info, not USDC.e balance
   ```

4. **On-Chain Balance Verification:**
   ```python
   from web3 import Web3

   web3 = Web3(Web3.HTTPProvider("https://polygon-rpc.com"))
   USDC_E = "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174"

   abi = '[{"name":"balanceOf","inputs":[{"type":"address"}],"outputs":[{"type":"uint256"}],"type":"function"}]'
   contract = web3.eth.contract(address=USDC_E, abi=abi)

   # Check USDC.e balance
   balance = contract.functions.balanceOf(wallet_address).call()
   usdc_balance = balance / 1e6  # 6 decimals
   print(f"USDC.e: ${usdc_balance:.2f}")
   ```

5. **Cross-Reference to Data API:**
   - Detailed position tracking: ../data-analytics/positions-and-history.md
   - Data API provides richer position data including PnL
   - CLOB methods for quick position checks during trading

6. **Position Schema:**
   ```python
   {
       "market": "0x...",        # conditionId
       "asset_id": "71321...",   # token_id
       "size": "100.0",          # Number of shares
       "avg_price": "0.45",      # Average entry price
       "side": "BUY"
   }
   ```

7. **Before Order Validation:**
   ```python
   def can_place_sell_order(client, token_id, size):
       """Check if user has sufficient position to sell."""
       positions = client.get_positions(asset_id=token_id)
       total_position = sum(float(p["size"]) for p in positions)
       return total_position >= size

   def check_usdc_balance(web3, wallet, required_amount):
       """Check if user has sufficient USDC.e for buy."""
       contract = web3.eth.contract(address=USDC_E, abi=balance_abi)
       balance = contract.functions.balanceOf(wallet).call() / 1e6
       return balance >= required_amount
   ```

8. **Common Issues:**
   - Checking wrong address (EOA vs proxy)
   - Forgetting USDC.e has 6 decimals (not 18)
   - Not accounting for pending orders reducing available balance
  </action>
  <verify>File exists at skills/polymarket/trading/positions-and-balances.md with 80+ lines, includes CLOB position methods, on-chain balance checking, and validation patterns</verify>
  <done>Positions and balances documentation with CLOB methods and on-chain verification patterns</done>
</task>

</tasks>

<verification>
After completion, trading skill folder is complete with 6 files:
- README.md (Plan 03)
- clob-api-overview.md (Plan 03)
- order-types.md (Plan 03)
- order-placement.md (this plan)
- order-management.md (this plan)
- positions-and-balances.md (this plan)

All CLOB requirements (CLOB-01 through CLOB-06) are covered.
</verification>

<success_criteria>
1. Complete order placement workflow documented with request/response schemas
2. Cancellation patterns documented (single, all, batch)
3. Order status checking and open orders retrieval documented
4. Position viewing documented with CLOB methods
5. Balance checking documented with on-chain verification
6. Batch operations documented with max 15 order limit
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-api-documentation/02-04-SUMMARY.md`

Update skills/polymarket/trading/README.md to add links to new files.
</output>
