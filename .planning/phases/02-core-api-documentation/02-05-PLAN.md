---
phase: 02-core-api-documentation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/polymarket/data-analytics/README.md
  - skills/polymarket/data-analytics/data-api-overview.md
  - skills/polymarket/data-analytics/positions-and-history.md
  - skills/polymarket/data-analytics/historical-prices.md
autonomous: true

must_haves:
  truths:
    - "Documentation explains Data API base URL and purpose"
    - "Documentation covers position and balance retrieval"
    - "Documentation covers trade history queries"
    - "Documentation covers historical price data access"
    - "Code examples demonstrate all major Data API operations"
  artifacts:
    - path: "skills/polymarket/data-analytics/README.md"
      provides: "Index for data analytics skill"
      min_lines: 50
    - path: "skills/polymarket/data-analytics/data-api-overview.md"
      provides: "Data API architecture and endpoints"
      min_lines: 60
    - path: "skills/polymarket/data-analytics/positions-and-history.md"
      provides: "Positions, balances, and trade history"
      min_lines: 100
    - path: "skills/polymarket/data-analytics/historical-prices.md"
      provides: "Price timeseries and history"
      min_lines: 60
  key_links:
    - from: "skills/polymarket/data-analytics/README.md"
      to: "data-api-overview.md, positions-and-history.md"
      via: "documentation index links"
      pattern: "\\[.*\\]\\(\\./.*\\.md\\)"
---

<objective>
Document the Data API for positions, trade history, and historical price data.

Purpose: Enable Claude to retrieve user-specific data for portfolio tracking and analytics. Covers DATA-01 (positions/balances), DATA-02 (trade history), DATA-03 (historical prices).

Output: Four skill files in skills/polymarket/data-analytics/ covering Data API functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-api-documentation/02-RESEARCH.md

# Reference Phase 1 style
@skills/polymarket/auth/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Data API overview and README</name>
  <files>skills/polymarket/data-analytics/data-api-overview.md, skills/polymarket/data-analytics/README.md</files>
  <action>
Create Data API overview (data-api-overview.md) covering:

1. **API Basics:**
   - Base URL: `https://data-api.polymarket.com`
   - Purpose: User-specific data - positions, balances, trade history, PnL
   - No authentication required (queries by public wallet address)
   - Complements CLOB API (trading) and Gamma API (discovery)

2. **Key Endpoints:**
   - GET /positions - User positions with PnL
   - GET /activity - Trade history and events
   - GET /balances - Token balances

3. **When to Use Data API vs CLOB:**
   | Need | Use | Why |
   |------|-----|-----|
   | Quick position check during trading | CLOB get_positions() | Lower latency |
   | Detailed PnL and portfolio analytics | Data API /positions | Rich data |
   | Trade history for accounting | Data API /activity | Complete records |
   | Historical price charts | CLOB /prices-history | Part of CLOB |

4. **Query Pattern:**
   ```python
   import requests

   DATA_URL = "https://data-api.polymarket.com"

   def get_positions(wallet_address: str, **kwargs):
       response = requests.get(f"{DATA_URL}/positions", params={
           "user": wallet_address,
           **kwargs
       })
       response.raise_for_status()
       return response.json()
   ```

---

Create README (README.md) for data-analytics skill:

1. **Quick Start:**
   - Code snippet for fetching positions
   - No auth needed - just wallet address

2. **Prerequisites:**
   - Python with requests library
   - Wallet address to query
   - No API keys required

3. **Documentation Index:**
   - data-api-overview.md - API architecture
   - positions-and-history.md - Positions and trade history
   - historical-prices.md - Price timeseries
   - (placeholder for portfolio-export.md - Plan 06)

4. **Common Use Cases:**
   - Portfolio tracking dashboard
   - PnL calculation
   - Trade history export
   - Performance analytics

5. **Related Skills:**
   - Trading (../trading/) - Place orders
   - Market Discovery (../market-discovery/) - Find markets
  </action>
  <verify>Both files exist: data-api-overview.md (60+ lines) and README.md (50+ lines) with proper structure</verify>
  <done>Data API overview and README created with endpoint reference and skill index</done>
</task>

<task type="auto">
  <name>Task 2: Create positions and trade history documentation</name>
  <files>skills/polymarket/data-analytics/positions-and-history.md</files>
  <action>
Create comprehensive positions and trade history documentation (DATA-01, DATA-02) covering:

1. **Fetching Positions (DATA-01):**
   ```python
   import requests

   DATA_URL = "https://data-api.polymarket.com"

   def get_positions(wallet_address: str, limit=100, sort_by="TOKENS"):
       """Get current positions with PnL data."""
       response = requests.get(f"{DATA_URL}/positions", params={
           "user": wallet_address,
           "limit": limit,
           "sortBy": sort_by,
           "sortDirection": "DESC",
           "sizeThreshold": 1  # Minimum position size
       })
       response.raise_for_status()
       return response.json()
   ```

2. **Position Query Parameters:**
   - user: Wallet address (required)
   - limit: Max results (default varies)
   - sortBy: CURRENT, INITIAL, TOKENS, CASHPNL, PERCENTPNL
   - sortDirection: ASC, DESC
   - sizeThreshold: Minimum position size to include

3. **Position Response Schema:**
   ```python
   {
       "proxyWallet": "0x...",     # Trading wallet
       "asset": "71321...",        # Token ID
       "conditionId": "0x...",     # Market ID
       "size": 100.0,              # Number of shares
       "avgPrice": 0.45,           # Average entry price
       "initialValue": 45.0,       # Entry value (size * avgPrice)
       "currentValue": 50.0,       # Current value (size * curPrice)
       "cashPnl": 5.0,             # Unrealized PnL in $
       "percentPnl": 11.11,        # Unrealized PnL in %
       "curPrice": 0.50,           # Current market price
       "title": "Will X happen?",  # Market question
       "outcome": "Yes",           # Position side
       "endDate": "2026-12-31T00:00:00Z"
   }
   ```

4. **Balance Retrieval:**
   ```python
   def get_balances(wallet_address: str):
       """Get token balances."""
       response = requests.get(f"{DATA_URL}/balances", params={
           "user": wallet_address
       })
       response.raise_for_status()
       return response.json()
   ```

5. **Trade History (DATA-02):**
   ```python
   def get_trade_history(wallet_address: str, activity_types=None, limit=100):
       """Get trade and activity history."""
       params = {
           "user": wallet_address,
           "limit": limit,
           "sortBy": "TIMESTAMP",
           "sortDirection": "DESC"
       }

       if activity_types:
           # TRADE, SPLIT, MERGE, REDEEM, REWARD, CONVERSION, MAKER_REBATE
           params["type"] = ",".join(activity_types)

       response = requests.get(f"{DATA_URL}/activity", params=params)
       response.raise_for_status()
       return response.json()
   ```

6. **Activity Types:**
   | Type | Description |
   |------|-------------|
   | TRADE | Order fills |
   | SPLIT | Token split operation |
   | MERGE | Token merge operation |
   | REDEEM | Market resolution payout |
   | REWARD | Liquidity rewards |
   | CONVERSION | NegRisk conversion |
   | MAKER_REBATE | Maker rebate credit |

7. **Activity Response Schema:**
   ```python
   {
       "id": "...",
       "type": "TRADE",
       "user": "0x...",
       "timestamp": "2024-01-15T10:30:00Z",
       "market": "0x...",
       "asset": "71321...",
       "side": "BUY",
       "size": 100.0,
       "price": 0.45,
       "fee": 0.0,
       "transactionHash": "0x..."
   }
   ```

8. **Pagination for Large Histories:**
   ```python
   def fetch_all_activity(wallet_address: str, limit=100):
       """Generator for paginated activity history."""
       offset = 0
       while True:
           params = {
               "user": wallet_address,
               "limit": limit,
               "offset": offset,
               "sortBy": "TIMESTAMP",
               "sortDirection": "DESC"
           }
           response = requests.get(f"{DATA_URL}/activity", params=params)
           batch = response.json()

           if not batch:
               break

           yield from batch

           if len(batch) < limit:
               break

           offset += limit
   ```
  </action>
  <verify>File exists at skills/polymarket/data-analytics/positions-and-history.md with 100+ lines, includes positions, balances, trade history, and pagination</verify>
  <done>Complete positions and trade history documentation with schemas and pagination patterns</done>
</task>

<task type="auto">
  <name>Task 3: Create historical prices documentation</name>
  <files>skills/polymarket/data-analytics/historical-prices.md</files>
  <action>
Create historical prices documentation (DATA-03) covering:

1. **Prices History Endpoint:**
   Note: Historical prices are via CLOB API, not Data API
   ```python
   import requests

   def get_price_history(token_id: str, interval: str = "1d"):
       """Get historical price data for a token."""
       response = requests.get("https://clob.polymarket.com/prices-history", params={
           "market": token_id,
           "interval": interval
       })
       response.raise_for_status()
       return response.json()
   ```

2. **Interval Options:**
   | Interval | Description | Use Case |
   |----------|-------------|----------|
   | 1m | 1 minute candles | Real-time trading |
   | 1h | 1 hour candles | Intraday analysis |
   | 6h | 6 hour candles | Multi-day trends |
   | 1d | 1 day candles | Long-term charts |
   | 1w | 1 week candles | Historical overview |
   | max | All available data | Full history |

3. **Response Schema:**
   ```python
   {
       "history": [
           {
               "t": 1705320000,  # Unix timestamp
               "p": "0.45"       # Price at time
           },
           {
               "t": 1705406400,
               "p": "0.48"
           }
       ]
   }
   ```

4. **Converting to DataFrame:**
   ```python
   import pandas as pd
   from datetime import datetime

   def prices_to_dataframe(price_history):
       """Convert price history to pandas DataFrame."""
       df = pd.DataFrame(price_history["history"])
       df["timestamp"] = pd.to_datetime(df["t"], unit="s")
       df["price"] = df["p"].astype(float)
       df = df.drop(columns=["t", "p"])
       return df.set_index("timestamp")

   # Usage
   history = get_price_history(token_id, "1d")
   df = prices_to_dataframe(history)
   print(df.tail())
   ```

5. **Charting Example:**
   ```python
   import matplotlib.pyplot as plt

   def plot_price_history(token_id: str, title: str = "Price History"):
       history = get_price_history(token_id, "1d")
       df = prices_to_dataframe(history)

       plt.figure(figsize=(12, 6))
       plt.plot(df.index, df["price"])
       plt.title(title)
       plt.xlabel("Date")
       plt.ylabel("Price")
       plt.grid(True)
       plt.show()
   ```

6. **Data Availability Notes:**
   - History available from market creation
   - "max" interval provides all available data
   - Data retention period: TBD (test with specific markets)
   - No authentication required

7. **Multi-Market Comparison:**
   ```python
   def compare_markets(token_ids: list, interval: str = "1d"):
       """Fetch and align price history for multiple markets."""
       dataframes = {}
       for token_id in token_ids:
           history = get_price_history(token_id, interval)
           df = prices_to_dataframe(history)
           dataframes[token_id] = df

       # Merge on timestamp
       combined = pd.concat(dataframes, axis=1)
       combined.columns = [f"market_{i}" for i in range(len(token_ids))]
       return combined
   ```

8. **Limitations:**
   - Rate limits apply (implement delays between requests)
   - Large intervals may have gaps
   - Real-time data better via WebSocket
  </action>
  <verify>File exists at skills/polymarket/data-analytics/historical-prices.md with 60+ lines, includes endpoint, intervals, DataFrame conversion, and charting example</verify>
  <done>Historical prices documentation with timeseries access patterns and visualization examples</done>
</task>

</tasks>

<verification>
After completion, data-analytics skill folder has 4 files:
- README.md
- data-api-overview.md
- positions-and-history.md
- historical-prices.md

DATA-01, DATA-02, DATA-03 requirements covered. DATA-04 (portfolio export) will be covered in Plan 06.
</verification>

<success_criteria>
1. Data API architecture documented with endpoint reference
2. Position retrieval documented with response schema and PnL fields
3. Trade history documented with activity types and pagination
4. Historical price access documented with interval options
5. DataFrame conversion and charting patterns included
6. Clear distinction between Data API and CLOB API usage
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-api-documentation/02-05-SUMMARY.md`
</output>
