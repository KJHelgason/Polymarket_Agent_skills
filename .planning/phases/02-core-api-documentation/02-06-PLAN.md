---
phase: 02-core-api-documentation
plan: 06
type: execute
wave: 2
depends_on: ["02-05"]
files_modified:
  - skills/polymarket/data-analytics/portfolio-export.md
autonomous: true

must_haves:
  truths:
    - "Documentation covers portfolio export patterns for accounting"
    - "Documentation shows CSV/JSON export implementations"
    - "Documentation explains how to aggregate PnL data"
  artifacts:
    - path: "skills/polymarket/data-analytics/portfolio-export.md"
      provides: "Portfolio export patterns for accounting"
      min_lines: 80
  key_links:
    - from: "skills/polymarket/data-analytics/portfolio-export.md"
      to: "positions-and-history.md"
      via: "uses position and history data"
      pattern: "positions|activity"
---

<objective>
Complete Data API documentation with portfolio export patterns for accounting.

Purpose: Enable Claude to help users export their trading data for tax reporting and portfolio tracking. Covers DATA-04 (portfolio export patterns).

Output: One skill file completing the data-analytics skill folder.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-api-documentation/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create portfolio export documentation</name>
  <files>skills/polymarket/data-analytics/portfolio-export.md</files>
  <action>
Create comprehensive portfolio export documentation (DATA-04) covering:

1. **Export Use Cases:**
   - Tax reporting (capital gains/losses)
   - Portfolio performance tracking
   - Trade journal maintenance
   - Accounting reconciliation

2. **Complete Portfolio Export Function:**
   ```python
   import requests
   import csv
   import json
   from datetime import datetime

   DATA_URL = "https://data-api.polymarket.com"

   def export_portfolio(wallet_address: str, output_format: str = "csv"):
       """Export complete portfolio data for accounting."""

       # 1. Fetch all positions
       positions = requests.get(f"{DATA_URL}/positions", params={
           "user": wallet_address,
           "limit": 1000,
           "sizeThreshold": 0  # Include all positions
       }).json()

       # 2. Fetch all activity
       activity = []
       offset = 0
       while True:
           batch = requests.get(f"{DATA_URL}/activity", params={
               "user": wallet_address,
               "limit": 100,
               "offset": offset,
               "sortBy": "TIMESTAMP",
               "sortDirection": "ASC"
           }).json()

           if not batch:
               break
           activity.extend(batch)
           if len(batch) < 100:
               break
           offset += 100

       if output_format == "csv":
           return export_to_csv(positions, activity, wallet_address)
       else:
           return export_to_json(positions, activity, wallet_address)
   ```

3. **CSV Export for Trades:**
   ```python
   def export_trades_csv(activity: list, filename: str):
       """Export trade history to CSV for accounting software."""
       fieldnames = [
           "date", "time", "type", "market_title", "outcome",
           "side", "quantity", "price", "total", "fee", "tx_hash"
       ]

       with open(filename, "w", newline="") as f:
           writer = csv.DictWriter(f, fieldnames=fieldnames)
           writer.writeheader()

           for trade in activity:
               if trade["type"] != "TRADE":
                   continue

               dt = datetime.fromisoformat(trade["timestamp"].replace("Z", "+00:00"))
               row = {
                   "date": dt.strftime("%Y-%m-%d"),
                   "time": dt.strftime("%H:%M:%S"),
                   "type": trade["type"],
                   "market_title": trade.get("title", ""),
                   "outcome": trade.get("outcome", ""),
                   "side": trade["side"],
                   "quantity": trade["size"],
                   "price": trade["price"],
                   "total": float(trade["size"]) * float(trade["price"]),
                   "fee": trade.get("fee", 0),
                   "tx_hash": trade.get("transactionHash", "")
               }
               writer.writerow(row)

       return filename
   ```

4. **Position Summary Export:**
   ```python
   def export_positions_summary(positions: list, filename: str):
       """Export current positions with PnL summary."""
       fieldnames = [
           "market", "outcome", "shares", "avg_price", "current_price",
           "initial_value", "current_value", "unrealized_pnl", "pnl_percent",
           "end_date"
       ]

       with open(filename, "w", newline="") as f:
           writer = csv.DictWriter(f, fieldnames=fieldnames)
           writer.writeheader()

           for pos in positions:
               row = {
                   "market": pos.get("title", ""),
                   "outcome": pos.get("outcome", ""),
                   "shares": pos["size"],
                   "avg_price": pos["avgPrice"],
                   "current_price": pos["curPrice"],
                   "initial_value": pos["initialValue"],
                   "current_value": pos["currentValue"],
                   "unrealized_pnl": pos["cashPnl"],
                   "pnl_percent": pos["percentPnl"],
                   "end_date": pos.get("endDate", "")
               }
               writer.writerow(row)

       return filename
   ```

5. **PnL Aggregation:**
   ```python
   def calculate_pnl_summary(positions: list, activity: list):
       """Calculate aggregate PnL metrics."""

       # Unrealized PnL (open positions)
       unrealized_pnl = sum(float(p["cashPnl"]) for p in positions)
       total_position_value = sum(float(p["currentValue"]) for p in positions)

       # Realized PnL (from redemptions)
       redemptions = [a for a in activity if a["type"] == "REDEEM"]
       realized_pnl = sum(float(r.get("amount", 0)) for r in redemptions)

       # Trade volume
       trades = [a for a in activity if a["type"] == "TRADE"]
       total_volume = sum(
           float(t["size"]) * float(t["price"])
           for t in trades
       )

       return {
           "unrealized_pnl": unrealized_pnl,
           "realized_pnl": realized_pnl,
           "total_pnl": unrealized_pnl + realized_pnl,
           "total_position_value": total_position_value,
           "total_trade_volume": total_volume,
           "total_trades": len(trades),
           "open_positions": len(positions)
       }
   ```

6. **JSON Export for Analysis:**
   ```python
   def export_to_json(positions: list, activity: list, wallet: str):
       """Export complete portfolio data as JSON."""
       summary = calculate_pnl_summary(positions, activity)

       export_data = {
           "wallet": wallet,
           "export_date": datetime.utcnow().isoformat(),
           "summary": summary,
           "positions": positions,
           "activity": activity
       }

       filename = f"polymarket_portfolio_{wallet[:8]}_{datetime.now().strftime('%Y%m%d')}.json"
       with open(filename, "w") as f:
           json.dump(export_data, f, indent=2)

       return filename
   ```

7. **Tax Lot Tracking:**
   ```python
   def calculate_tax_lots(activity: list):
       """Calculate cost basis using FIFO method."""
       lots = {}  # token_id -> list of (quantity, price, date)

       for trade in sorted(activity, key=lambda x: x["timestamp"]):
           if trade["type"] != "TRADE":
               continue

           token = trade["asset"]
           if token not in lots:
               lots[token] = []

           if trade["side"] == "BUY":
               # Add new lot
               lots[token].append({
                   "quantity": float(trade["size"]),
                   "price": float(trade["price"]),
                   "date": trade["timestamp"]
               })
           else:  # SELL
               # Match against oldest lots (FIFO)
               sell_qty = float(trade["size"])
               sell_price = float(trade["price"])

               while sell_qty > 0 and lots[token]:
                   lot = lots[token][0]
                   matched = min(lot["quantity"], sell_qty)

                   gain = matched * (sell_price - lot["price"])
                   # Record: gain, holding_period, etc.

                   lot["quantity"] -= matched
                   sell_qty -= matched

                   if lot["quantity"] <= 0:
                       lots[token].pop(0)

       return lots
   ```

8. **Date Range Filtering:**
   ```python
   def export_date_range(wallet: str, start_date: str, end_date: str):
       """Export activity within a specific date range."""
       all_activity = fetch_all_activity(wallet)

       start = datetime.fromisoformat(start_date)
       end = datetime.fromisoformat(end_date)

       filtered = [
           a for a in all_activity
           if start <= datetime.fromisoformat(a["timestamp"].replace("Z", "+00:00")) <= end
       ]

       return filtered
   ```

9. **Accounting Software Compatibility:**
   - CSV format compatible with most accounting software
   - Date format: YYYY-MM-DD (ISO 8601)
   - Time in UTC
   - Amounts as decimal numbers (not formatted strings)
  </action>
  <verify>File exists at skills/polymarket/data-analytics/portfolio-export.md with 80+ lines, includes CSV export, JSON export, PnL aggregation, and tax lot tracking</verify>
  <done>Complete portfolio export documentation with accounting-ready export patterns</done>
</task>

</tasks>

<verification>
After completion, data-analytics skill folder is complete with 5 files:
- README.md
- data-api-overview.md
- positions-and-history.md
- historical-prices.md
- portfolio-export.md

All DATA requirements (DATA-01 through DATA-04) are covered.
</verification>

<success_criteria>
1. Portfolio export patterns documented for accounting use cases
2. CSV export for trades and positions documented
3. JSON export for complete portfolio data documented
4. PnL aggregation function documented
5. Tax lot tracking with FIFO method documented
6. Date range filtering for tax periods documented
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-api-documentation/02-06-SUMMARY.md`

Update skills/polymarket/data-analytics/README.md to add link to portfolio-export.md.
</output>
