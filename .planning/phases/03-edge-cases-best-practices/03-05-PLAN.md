---
phase: 03-edge-cases-best-practices
plan: 05
type: execute
wave: 2
depends_on: [03-01, 03-02, 03-03, 03-04]
files_modified:
  - skills/polymarket/library/production-patterns.md
  - skills/polymarket/edge-cases/README.md
autonomous: true

must_haves:
  truths:
    - "User can implement rate limiting for high-frequency trading"
    - "User understands burst vs sustained rate limits"
    - "User can implement proper WebSocket reconnection patterns"
    - "User can track balance changes for position reconciliation"
  artifacts:
    - path: "skills/polymarket/library/production-patterns.md"
      provides: "Production-ready patterns for rate limiting, reconnection, balance tracking"
      contains: "RateLimiter"
  key_links:
    - from: "skills/polymarket/library/production-patterns.md"
      to: "skills/polymarket/real-time/connection-management.md"
      via: "WebSocket reconnection reference"
      pattern: "connection-management"
    - from: "skills/polymarket/library/production-patterns.md"
      to: "skills/polymarket/library/error-handling.md"
      via: "error handling integration"
      pattern: "error-handling"
---

<objective>
Create production patterns guide covering rate limiting, WebSocket reliability, and balance tracking for production-ready integrations.

Purpose: Production deployments need reliable patterns beyond basic API usage. This consolidates best practices for high-volume, long-running applications.

Output: library/production-patterns.md (also finalizes edge-cases README cross-references)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-edge-cases-best-practices/03-RESEARCH.md

# Prior plan outputs for integration
@.planning/phases/03-edge-cases-best-practices/03-04-SUMMARY.md

# Existing documentation to reference
@skills/polymarket/real-time/connection-management.md
@skills/polymarket/data-analytics/positions-and-history.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create production patterns guide</name>
  <files>skills/polymarket/library/production-patterns.md</files>
  <action>
Create library/production-patterns.md (LIB-02, LIB-04):

**Title:** "Production Usage Patterns"

**Section 1: Rate Limiting (LIB-04)**

Include RATE_LIMITS reference from research with all endpoints:
- General: 15,000/10s
- Trading POST /order: 3,500/10s burst, 36,000/10min sustained
- Trading DELETE /order: 3,000/10s burst, 30,000/10min sustained
- Batch operations: 1,000/10s burst, 15,000/10min sustained
- Batch limit: 15 orders per request

Include RateLimiter class from research:
```python
class RateLimiter:
    """Rate limiter respecting Polymarket API limits."""
    def __init__(self, max_calls: int, window_seconds: float):
        ...
    def wait_if_needed(self):
        ...
```

Recommended limiter configurations:
```python
order_limiter = RateLimiter(max_calls=350, window_seconds=1)  # 350/s orders
cancel_limiter = RateLimiter(max_calls=300, window_seconds=1)  # 300/s cancels
```

Note: Polymarket uses Cloudflare throttling - requests are QUEUED not dropped at 429.

**Section 2: WebSocket Reconnection (LIB-04)**

Reference connection-management.md for full patterns, summarize key points:
- 5-second heartbeat interval
- 5-minute data timeout threshold
- Exponential backoff with jitter (1s -> 60s)
- Subscription restoration after reconnect

When to use which timeout:
| Use Case | Heartbeat | Data Timeout |
|----------|-----------|--------------|
| High-frequency trading | 5s | 60s |
| Dashboard monitoring | 5s | 300s |
| Low-activity markets | 5s | 900s |

**Section 3: Balance Tracking (LIB-04)**

Pattern for tracking USDC.e balance changes:
```python
from web3 import Web3

def get_usdc_e_balance(wallet_address: str) -> float:
    """Get current USDC.e balance on-chain."""
    web3 = Web3(Web3.HTTPProvider("https://polygon-rpc.com"))
    USDC_E = "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174"
    # ... balance check code
    return balance / 1e6

class BalanceTracker:
    """Track balance changes for reconciliation."""
    def __init__(self, wallet_address: str):
        self.wallet_address = wallet_address
        self.last_balance = None
        self.history = []

    def update(self):
        """Record current balance."""
        current = get_usdc_e_balance(self.wallet_address)
        if self.last_balance is not None:
            change = current - self.last_balance
            self.history.append({
                "timestamp": time.time(),
                "balance": current,
                "change": change
            })
        self.last_balance = current
        return current
```

**Section 4: Common Method Signatures (LIB-02)**

Quick reference for most-used py-clob-client methods:

| Method | Signature | Returns |
|--------|-----------|---------|
| create_order | (order_args: OrderArgs) | SignedOrder |
| post_order | (order: SignedOrder, type: OrderType) | dict |
| cancel | (order_id: str) | dict |
| cancel_all | () | dict |
| get_order | (order_id: str) | dict |
| get_orders | () | list[dict] |
| get_tick_size | (token_id: str) | float |
| get_midpoint | (token_id: str) | float |
| get_price | (token_id: str, side: str) | float |
| get_order_book | (token_id: str) | dict |

**Section 5: Production Checklist**

Before deploying:
- [ ] Rate limiter configured for all trading endpoints
- [ ] WebSocket reconnection with backoff implemented
- [ ] Error handling with PolyApiException categorization
- [ ] Balance tracking for reconciliation
- [ ] Logging for debugging production issues
- [ ] Graceful shutdown handling

Reference error-handling.md for exception patterns.
Reference connection-management.md for full WebSocket implementation.
  </action>
  <verify>
File exists at skills/polymarket/library/production-patterns.md.
Contains RateLimiter class.
Contains RATE_LIMITS reference.
Contains method signature quick reference table.
Contains production checklist.
References connection-management.md and error-handling.md.
  </verify>
  <done>
Production patterns guide provides rate limiting, WebSocket reliability, balance tracking, and method signatures for production deployments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Finalize library README and cross-references</name>
  <files>skills/polymarket/library/README.md</files>
  <action>
Update library/README.md to include:

1. Navigation to both library docs:
   - error-handling.md - Exception types and recovery
   - production-patterns.md - Rate limiting, WebSocket, balance tracking

2. Quick reference section:
   - Library version: py-clob-client 0.34.5+
   - GitHub: https://github.com/Polymarket/py-clob-client
   - PyPI: pip install py-clob-client

3. When to use this section:
   - Handling errors from API calls
   - Implementing rate limiting
   - Production deployment patterns
   - Method signature lookup

4. Link to auth/client-initialization.md for initial setup.

5. Link to edge-cases section for troubleshooting specific issues.

Ensure README serves as effective entry point to library documentation.
  </action>
  <verify>
library/README.md exists with links to both library docs.
Contains quick reference info (version, GitHub, PyPI).
Links to related sections (auth, edge-cases).
  </verify>
  <done>
Library README finalized with complete navigation and quick reference information.
  </done>
</task>

</tasks>

<verification>
- [ ] library/production-patterns.md exists with all sections
- [ ] RateLimiter class included with proper configuration
- [ ] Method signatures table complete
- [ ] library/README.md updated with full navigation
- [ ] Cross-references to existing docs correct
</verification>

<success_criteria>
1. User can implement proper rate limiting for any trading volume
2. User knows burst vs sustained limits
3. User can implement production-ready WebSocket connections
4. User can track balances for reconciliation
5. User has quick reference for common methods
6. LIB-02, LIB-04 requirements satisfied
7. Phase 3 documentation complete and navigable
</success_criteria>

<output>
After completion, create `.planning/phases/03-edge-cases-best-practices/03-05-SUMMARY.md`
</output>
